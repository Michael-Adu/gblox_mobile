<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arduino Test</title>
  <script src="../../blockly_compressed.js"></script>
  <script src="../../blocks_compressed.js"></script>
  <script src="../../javascript_compressed.js"></script>
  <script src="../../msg/js/en.js"></script>

  <script type="text/javascript">
    import Actuators from "./SVGs/Actuators.png"
    import Sensors from "./SVGs/Sensors.png"
    import COM from "./SVGs/COM.png"
    import LED from "./SVGs/LED.png"
    import Default from "./SVGs/Default.png"
    import Sound from "./SVGs/Sound.png"



    Blockly.Blocks['sensor_ultrasonic'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Sensors, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" read Ultrasonic Sensor value");
        this.setOutput(true, null);
        this.setColour(230);
        this.setInputsInline(true);
        this.setTooltip("");
        this.setStyle("sensor_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['sensor_light_follower_right'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Sensors, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" read Right Light Follower value");
        this.setOutput(true, null);
        this.setColour(230);
        this.setInputsInline(true);
        this.setTooltip("");
        this.setStyle("sensor_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['sensor_light_follower_left'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Sensors, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" read Left Light Follower value");
        this.setOutput(true, null);
        this.setColour(230);
        this.setInputsInline(true);
        this.setTooltip("");
        this.setStyle("sensor_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['sensor_line_follower_right'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Sensors, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField("Right Line Follower is")
          .appendField(new Blockly.FieldDropdown([["On", "On"], ["Off", "Off"]]), "Right Line Follower Value");
        this.setOutput(true, null);
        this.setColour(230);
        this.setInputsInline(true);
        this.setTooltip("");
        this.setStyle("sensor_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['sensor_line_follower_left'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Sensors, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField("Left Line Follower is")
          .appendField(new Blockly.FieldDropdown([["On", "On"], ["Off", "Off"]]), "Left Line Follower Value");
        this.setOutput(true, null);
        this.setInputsInline(true);
        this.setTooltip("");
        this.setStyle("sensor_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['communication_infrared_start'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(COM, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" start Infrared Communication");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setTooltip("");
        this.setStyle("communication_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['communication_infrared_value'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(COM, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField("When Remote button ")
          .appendField(new Blockly.FieldDropdown([["Up", "46"], ["Down", "15"], ["Right", "43"], ["Left", "44"], ["Ok", "40"], ["1", "16"], ["2", "19"], ["3", "D"], ["4", "C"], ["5", "18"], ["6", "5E"], ["7", "8"], ["8", "1C"], ["9", "5A"], ["0", "52"], ["#", "4A"], ["*", "42"]]), "Received_Character")
          .appendField("is pressed");
        this.appendStatementInput("IR_Decode_Loop")
          .setCheck(null);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setTooltip("");
        this.setStyle("communication_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['communication_bluetooth_start'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(COM, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" start Bluetooth Communication");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setInputsInline(true);
        this.setTooltip("");
        this.setStyle("communication_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['communication_bluetooth_receive'] = {
      init: function () {
        this.appendValueInput("NAME")
          .setCheck(["Number", "String"])
          .appendField(new Blockly.FieldImage(COM, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField("When Bluetooth Character is");
        this.setInputsInline(true);
        this.setOutput(true, null);
        this.setColour(230);
        this.setTooltip("");
        this.setStyle("communication_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['communincation_bluetooth_send'] = {
      init: function () {
        this.appendValueInput("NAME")
          .setCheck(null)
          .appendField(new Blockly.FieldImage(COM, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" send Bluetooth Character ");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setTooltip("");
        this.setStyle("communication_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['sound_buzzer_buzz'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Sound, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField("play note ")
          .appendField(new Blockly.FieldDropdown([["C6", "1047"], ["C#6", "1109"], ["D6", "1175"], ["Eb6", "1245"], ["E6", "1319"], ["F6", "1397"], ["F#6", "1480"], ["G6", "1568"], ["G#6", "1661"], ["A6", "1760"], ["Bb6", "1865"], ["B6", "1976"], ["C7", "2093"], ["C#7", "2217"], ["D7", "2349"], ["Eb7", "2489"], ["E7", "2637"], ["F7", "2794"], ["F#7", "2960"], ["G7", "3136"], ["G#7", "3322"], ["A7", "3520"], ["Bb7", "3729"], ["B7", "3951"], ["C8", "4186"]]), "Note");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setInputsInline(true);
        this.setTooltip("");
        this.setStyle("sound_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['sound_buzzer_timer'] = {
      init: function () {
        this.appendValueInput("Buzzer Time")
          .setCheck("Number")
          .appendField(new Blockly.FieldImage(Sound, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" play note")
          .appendField(new Blockly.FieldDropdown([["C6", "1047"], ["C#6", "1109"], ["D6", "1175"], ["Eb6", "1245"], ["E6", "1319"], ["F6", "1397"], ["F#6", "1480"], ["G6", "1568"], ["G#6", "1661"], ["A6", "1760"], ["Bb6", "1865"], ["B6", "1976"], ["C7", "2093"], ["C#7", "2217"], ["D7", "2349"], ["Eb7", "2489"], ["E7", "2637"], ["F7", "2794"], ["F#7", "2960"], ["G7", "3136"], ["G#7", "3322"], ["A7", "3520"], ["Bb7", "3729"], ["B7", "3951"], ["C8", "4186"]]), "note")
          .appendField("for");
        this.appendDummyInput()
          .appendField("seconds");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setTooltip("");
        this.setStyle("sound_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['sound_buzzer_stop'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Sound, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" stop the buzzer");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setTooltip("");
        this.setStyle("sound_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['led_rgb_led'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(LED, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" set")
          .appendField(new Blockly.FieldDropdown([["Red", "Red"], ["Blue", "Blue"], ["Green", "Green"]]), "colour")
          .appendField("Light")
          .appendField(new Blockly.FieldDropdown([["On", "On"], ["Off", "Off"]]), "colour value");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setInputsInline(true);
        this.setTooltip("");
        this.setStyle("led_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['led_rgb_led_all'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(LED, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" set color to")
          .appendField(new Blockly.FieldDropdown([["Red", "Red"], ["Blue", "Blue"], ["Green", "Green"], ["Yellow", "Yellow"], ["Magenta", "Magenta"], ["Cyan", "Cyan"], ["Off", "Off"]]), "colour")
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(230);
        this.setInputsInline(true);
        this.setTooltip("");
        this.setStyle("led_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['motor_move_indef'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Actuators, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField("")
          .appendField(new Blockly.FieldDropdown([["move forward", "forward"], ["move backward", "backward"], ["stop", "stop"], ["turn left", "left"], ["turn right", "right"], ["rotate left", "rleft"], ["rotate right", "rright"]]), "direction");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(120);
        this.setTooltip("");
        this.setStyle("actuator_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['motor_single_move_indef'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Actuators, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" turn")
          .appendField(new Blockly.FieldDropdown([["Left Motor", "lm"], ["Right Motor", "rm"]]), "motorselect")
          .appendField(new Blockly.FieldDropdown([["forward", "forward"], ["backward", "backward"], ["to a stop", "stop"]]), "direction");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(120);
        this.setTooltip("");
        this.setStyle("actuator_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['motor_move_seconds'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Actuators, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField("")
          .appendField(new Blockly.FieldDropdown([["move forward", "forward"], ["move backward", "backward"], ["stop", "stop"], ["rotate left", "rleft"], ["rotate right", "rright"]]), "direction");
        this.appendValueInput("seconds")
          .setCheck("Number")
          .appendField("for");
        this.appendDummyInput()
          .appendField("seconds");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(120);
        this.setTooltip("");
        this.setStyle("actuator_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['forklift_move_seconds'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Actuators, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" rotate forklift")
          .appendField(new Blockly.FieldDropdown([["slowly", "slow"], ["moderately", "medium"], ["quickly", "fast"]]), "speed");
        this.appendValueInput("seconds")
          .setCheck("Number")
          .appendField("to");
        this.appendDummyInput()
          .appendField("degrees");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(120);
        this.setTooltip("");
        this.setStyle("actuator_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['forklift_move_indef'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage(Actuators, 25, 25, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" ")
          .appendField(new Blockly.FieldDropdown([["raise", "up"], ["lower", "down"], ["stop", "stop"]]), "direction")
          .appendField("the forklift ")
          .appendField(new Blockly.FieldDropdown([["slowly", "slow"], ["moderately", "medium"], ["quickly", "fast"]]), "speed");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setTooltip("");
        this.setStyle("actuator_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['servo_rotate_to_degrees'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage("https://www.gstatic.com/codesite/ph/images/star_on.gif", 15, 15, { alt: "*", flipRtl: "FALSE" }))
          .appendField("stop the Servo Motor");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setTooltip("");
        this.setStyle("actuator_blocks");
        this.setHelpUrl("");
      }
    };

    Blockly.Blocks['servo_360_rotate_direction'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage("https://www.gstatic.com/codesite/ph/images/star_on.gif", 15, 15, { alt: "*", flipRtl: "FALSE" }))
          .appendField(" rotate Servo Motor")
          .appendField(new Blockly.FieldDropdown([["clockwise", "cw"], ["anti-clockwise", "acw"]]), "direction")
          .appendField(new Blockly.FieldDropdown([["slowly", "slow"], ["moderately", "medium"], ["quickly", "fast"]]), "speed");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setTooltip("");
        this.setStyle("actuator_blocks");
        this.setHelpUrl("");
      }
    };

// Blockly.Blocks['variable_set'] = {
//   init: function() {
//     this.appendDummyInput()
//         .appendField("Set Variable")
//         .appendField(new Blockly.FieldTextInput("var_name"), "varname");
//     this.appendValueInput("value")
//         .setCheck(["Number", "String"])
//         .appendField("to");
//     this.setInputsInline(true);
//     this.setPreviousStatement(true, null);
//     this.setNextStatement(true, null);
//     this.setColour(230);
//  this.setTooltip("");
//  this.setHelpUrl("");
//   }
// };

// Blockly.Blocks['variable_get'] = {
//   init: function() {
//     this.appendDummyInput()
//         .appendField("Get Variable")
//         .appendField(new Blockly.FieldTextInput("var_name"), "varname")
//         .appendField("'s value");
//     this.setInputsInline(true);
//     this.setOutput(true, null);
//     this.setColour(230);
//  this.setTooltip("");
//  this.setHelpUrl("");
//   }
// };

// Blockly.Blocks['variable_create_int'] = {
//   init: function() {
//     this.appendDummyInput()
//         .appendField("Create Integer Variable")
//         .appendField(new Blockly.FieldTextInput("var_name"), "varname");
//     this.setInputsInline(true);
//     this.setPreviousStatement(true, null);
//     this.setNextStatement(true, null);
//     this.setColour(230);
//  this.setTooltip("");
//  this.setHelpUrl("");
//   }
// };

// Blockly.Blocks['variable_create_float'] = {
//   init: function() {
//     this.appendDummyInput()
//         .appendField("Create Float Variable")
//         .appendField(new Blockly.FieldTextInput("var_name"), "varname");
//     this.setInputsInline(true);
//     this.setPreviousStatement(true, null);
//     this.setNextStatement(true, null);
//     this.setColour(230);
//  this.setTooltip("");
//  this.setHelpUrl("");
//   }
// };




  </script>

  <script type="text/javascript">
    var peripheral_PreDeclarations = "";
    var peripheral_BulkFunctions = "";
    var peripheral_SetupCode = "";

    const US_Trigger = 11;
    const US_Echo = 10;
    const Right_Light_Follower = "A1";
    const Left_Light_Follower = "A0";
    const Right_Line_Follower_Receiver = "A3";
    const Left_Line_Follower_Receiver = "A2";
    const LeftServo = 9;
    const RightServo = 8;
    const ForkliftServo = 10;
    const IR_Remote = 3;
    const BluetoothTX = 12;
    const BluetoothRX = 13;
    const Buzzer_Pin = 7;
    const RGB_R = 6;
    const RGB_G = 4;
    const RGB_B = 5;

    /*
    const LeftMotorCW =  0;
    const LeftMotorACW = 135;
    const RightMotorCW = 0;
    const RightMotorACW = 135;
    */


    const LeftMotorCW = 77;
    const LeftMotorACW = 101;
    const RightMotorCW = 78;
    const RightMotorACW = 100;


    var DSpeed = 530;

    var ServoDefined = false;
    var RGBDefined = false;
    var IR_Loop = ``;
    var IR_Statements = "";
    const ServoSetup = {
      PreDec: `\n
  #include <Servo.h>
  Servo LeftServo;
  Servo RightServo;
  Servo ForkliftServo;
  int ForkliftDegrees;
  \n`,
      Setup: `\n
  LeftServo.attach(${LeftServo});
  RightServo.attach(${RightServo});
  ForkliftServo.attach(${ForkliftServo});
  LeftServo.write(90);
  RightServo.write(90);
  ForkliftServo.write(90);
  ForkliftDegrees = 90;
  \n`,
      Bulk: `\n
  void raise_fork(float speed){
    for(int i = 90; i > 0; i--){
      if(i < 0) {
        i = 0;
      }
    ForkliftServo.write(i);
    delay(90/(speed*1000));
    }
  }
  
  void lower_fork(float speed){
    for(int i = 0; i < 90; i++){
      if(i > 90) {
        i = 90;
      }
    ForkliftServo.write(i);
    delay(90/(speed*1000));
    }
  }
  
  void set_fork(float speed, int angle){
    int nangle = map(angle, 0, 90, 90, 0);
    if (nangle > ForkliftDegrees) {
      nangle = min(nangle,90);
      for(int i = ForkliftDegrees; i < nangle ; i++){
        if(i < 0) {
          i = 0;
        }
        ForkliftServo.write(i);
        delay(90/(speed*1000));
      }
    } else if (nangle < ForkliftDegrees) {
      nangle = max(nangle, 0);
      for(int i = ForkliftDegrees; i > nangle ; i--){
        if(i < 0) {
          i = 0;
        }
        ForkliftServo.write(i);
        delay(90/(speed*1000));
      }
    }
  }
  \n`
    }


    function clearvars() {
      peripheral_PreDeclarations = "";
      peripheral_BulkFunctions = "";
      peripheral_SetupCode = "";
      ServoDefined = false;
      RGBDefined = false;
      IR_Loop = ``;
      IR_Statements = ``;
    }

    Blockly.JavaScript['sensor_ultrasonic'] = function (block) {
      console.log()
      var code = "read_ultrasonic(" + US_Trigger + "," + US_Echo + ")";
      if (peripheral_PreDeclarations.includes(`int US_Trigger = ${US_Trigger};\nint US_Echo = ${US_Echo};\n\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += `int US_Trigger = ${US_Trigger};\nint US_Echo = ${US_Echo};\n\n`;
          peripheral_SetupCode += `\tpinMode(${US_Trigger}, OUTPUT);\n\tpinMode(${US_Echo}, INPUT);\n`;
          peripheral_BulkFunctions += `\nint read_ultrasonic(int trigger, int echo){
            digitalWrite(trigger, LOW);
            delayMicroseconds(2);d 
            digitalWrite(trigger, HIGH);
            delayMicroseconds(10);
            digitalWrite(trigger, LOW);
            int duration = pulseIn(echo, HIGH);
            int distance = duration * 0.034 / 2;
            return distance;
        }`
        }

      }

      return [code, Blockly.JavaScript.ORDER_NONE];
    };

    Blockly.JavaScript['sensor_light_follower_right'] = function (block) {
      if (peripheral_PreDeclarations.includes() == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += `int Right_Light_Follower = ${Right_Light_Follower};\n`;
          peripheral_SetupCode += `\tpinMode(Right_Light_Follower, INPUT);\n`
        }
      }
      var code = `analogRead(Right_Light_Follower)`;
      return [code, Blockly.JavaScript.ORDER_NONE];
    };

    Blockly.JavaScript['sensor_light_follower_left'] = function (block) {
      if (peripheral_PreDeclarations.includes(`int Left_Light_Follower = ${Left_Light_Follower};\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += `int Left_Light_Follower = ${Left_Light_Follower};\n`;
          peripheral_SetupCode += `\tpinMode(Left_Light_Follower, INPUT);\n`
        }
      }
      var code = `analogRead(Left_Light_Follower)`;
      return [code, Blockly.JavaScript.ORDER_NONE];
    };

    Blockly.JavaScript['sensor_line_follower_right'] = function (block) {
      var dropdown_right_line_follower_value = block.getFieldValue('Right Line Follower Value');
      if (peripheral_PreDeclarations.includes(`int Right_Line_Follower_Receiver = ${Right_Line_Follower_Receiver};\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += `int Right_Line_Follower_Receiver = ${Right_Line_Follower_Receiver};\n`;
          peripheral_SetupCode += `\tpinMode(Right_Line_Follower_Receiver, INPUT);\n`;
        }
      }
      var sensor_val = 0;
      if (dropdown_right_line_follower_value === "On") {
        sensor_val = 1;
      }
      else {
        sensor_val = 0;
      }
      var code = `map(analogRead(Right_Line_Follower_Receiver),0,500,0,1)==${sensor_val}`;
      return [code, Blockly.JavaScript.ORDER_NONE];
    };

    Blockly.JavaScript['sensor_line_follower_left'] = function (block) {
      var dropdown_left_line_follower_value = block.getFieldValue('Left Line Follower Value');
      if (peripheral_PreDeclarations.includes(`int Left_Line_Follower_Receiver = ${Left_Line_Follower_Receiver};\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += `int Left_Line_Follower_Receiver = ${Left_Line_Follower_Receiver};\n`;
          peripheral_SetupCode += `\tpinMode(Left_Line_Follower_Receiver, INPUT);\n`;
        }
      }
      var sensor_val = 0;
      if (dropdown_left_line_follower_value === "On") {
        sensor_val = 1;
      }
      else {
        sensor_val = 0;
      }
      var code = `map(analogRead(Left_Line_Follower_Receiver),0,500,0,1)==${sensor_val}`;
      return [code, Blockly.JavaScript.ORDER_NONE];
    };

    Blockly.JavaScript['communication_infrared_start'] = function (block) {
      if (peripheral_PreDeclarations.includes(`#include <IRremote.h>\nint IR_Remote=${IR_Remote};\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += `#include <IRremote.h>\nint IR_Remote=${IR_Remote};\n`;
          peripheral_SetupCode += `\n\tIrReceiver.begin(IR_Remote, ENABLE_LED_FEEDBACK);\n`;
        }
      }
      var code = ``;
      return code;
    };

    Blockly.JavaScript['communication_infrared_value'] = function (block) {
      var dropdown_character = block.getFieldValue('Received_Character');
      var statements_ir_decode_loop = Blockly.JavaScript.statementToCode(block, 'IR_Decode_Loop');
      var code = ``
      if (block.getRootBlock().type == "m_mainloop") {
        IR_Loop += `if(IrReceiver.decodedIRData.command==0x${dropdown_character}){\n${statements_ir_decode_loop}\t\t}\n\t`;
      }
      return code;
    };

    Blockly.JavaScript['communication_bluetooth_start'] = function (block) {
      if (peripheral_PreDeclarations.includes(`#include <SoftwareSerial.h>\nSoftwareSerial hc06(${BluetoothRX},${BluetoothTX});\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += `#include <SoftwareSerial.h>\nSoftwareSerial hc06(${BluetoothRX},${BluetoothTX});\nchar bdata = '.';\n`
          peripheral_SetupCode += `\thc06.begin(9600);\n`;
        }
      }
      var code = 'while (hc06.available()>0){\n\tbdata = hc06.read();\n}\n';
      return code;
    };

    Blockly.JavaScript['communication_bluetooth_receive'] = function (block) {
      var value_name = Blockly.JavaScript.valueToCode(block, "NAME", Blockly.JavaScript.ORDER_ATOMIC);
      value_name = value_name.replaceAll(`'`, ``);
      /*
      if (peripheral_PreDeclarations.includes(`char bdata = 'a';\n`)==0){
        peripheral_PreDeclarations += `char bdata = 'a';\n`;
        peripheral_BulkFunctions += `char read_bluetooth(){\n\twhile (hc06.available()>0){\n\tbdata = hc06.read();\n}\n}\n`
      }
      */

      var code = `(bdata=='${value_name}')`;
      // TODO: Change ORDER_NONE to the correct strength.
      return [code, Blockly.JavaScript.ORDER_NONE];
    };

    Blockly.JavaScript['communincation_bluetooth_send'] = function (block) {
      var value_name = Blockly.JavaScript.valueToCode(block, 'NAME', Blockly.JavaScript.ORDER_ATOMIC);
      value_name = value_name.replaceAll(`'`, ``);

      if (peripheral_PreDeclarations.includes(`int send_bluetooth(char x);\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += `int send_bluetooth(char x);\n`;
          peripheral_BulkFunctions += `int send_bluetooth(char x){\n\thc06.write(x);\n}\n`
        }
      }

      // TODO: Assemble JavaScript into code variable.
      var code = `\tsend_bluetooth('${value_name}');\n`
      return code;
    };

    Blockly.JavaScript['sound_buzzer_buzz'] = function (block) {
      var dropdown_note = block.getFieldValue('Note');
      // TODO: Assemble JavaScript into code variable.
      var code = `tone(${Buzzer_Pin}, ${dropdown_note});\n`;
      return code;
    };

    Blockly.JavaScript['sound_buzzer_timer'] = function (block) {
      var dropdown_name = block.getFieldValue('note');
      var value_buzzer_time = Blockly.JavaScript.valueToCode(block, 'Buzzer Time', Blockly.JavaScript.ORDER_ATOMIC);
      // TODO: Assemble JavaScript into code variable.
      var code = `\ntone(${Buzzer_Pin},${dropdown_name});\ndelay(${value_buzzer_time * 1000});\nnoTone(${Buzzer_Pin});`;
      return code;
    };

    Blockly.JavaScript['sound_buzzer_stop'] = function (block) {
      var code = `\tnoTone(${Buzzer_Pin});\n`;
      return code;
    };

    Blockly.JavaScript['led_rgb_led'] = function (block) {
      var dropdown_colour = block.getFieldValue('colour');
      var dropdown_colour_value = block.getFieldValue('colour value');
      // TODO: Assemble JavaScript into code variable.
      if (RGBDefined === false) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_SetupCode += `\tpinMode(${RGB_R}, OUTPUT);\n\tpinMode(${RGB_G}, OUTPUT);\n\tpinMode(${RGB_B}, OUTPUT);\n`
          RGBDefined = true;
        }

      }
      var code = '...;\n';
      switch (dropdown_colour) {
        case "Red":
          if (dropdown_colour_value === "On") {
            code = `digitalWrite(${RGB_R}, HIGH);\n`
          } else if (dropdown_colour_value === "Off") {
            code = `digitalWrite(${RGB_R}, LOW);\n`
          }
          break;
        case "Blue":
          if (dropdown_colour_value === "On") {
            code = `digitalWrite(${RGB_B}, HIGH);\n`
          } else if (dropdown_colour_value === "Off") {
            code = `digitalWrite(${RGB_B}, LOW);\n`
          }
          break;
        case "Green":
          if (dropdown_colour_value === "On") {
            code = `digitalWrite(${RGB_G}, HIGH);\n`
          } else if (dropdown_colour_value === "Off") {
            code = `digitalWrite(${RGB_G}, LOW);\n`
          }
          break;
        default:
          break;
      }
      return code;
    };

    Blockly.JavaScript['led_rgb_led_all'] = function (block) {
      var dropdown_colour = block.getFieldValue('colour');
      // TODO: Assemble JavaScript into code variable.
      if (RGBDefined === false) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_SetupCode += `\tpinMode(${RGB_R}, OUTPUT);\n\tpinMode(${RGB_G}, OUTPUT);\n\tpinMode(${RGB_B}, OUTPUT);\n`
          RGBDefined = true;
        }

      }
      var code = '...;\n';
      switch (dropdown_colour) {
        case "Red":
          code = `digitalWrite(${RGB_R}, HIGH);\ndigitalWrite(${RGB_G}, LOW);\ndigitalWrite(${RGB_B}, LOW);\n`
          break;
        case "Blue":
          code = `digitalWrite(${RGB_B}, HIGH);\ndigitalWrite(${RGB_G}, LOW);\ndigitalWrite(${RGB_R}, LOW);\n`
          break;
        case "Green":
          code = `digitalWrite(${RGB_G}, HIGH);\ndigitalWrite(${RGB_R}, LOW);\ndigitalWrite(${RGB_B}, LOW);\n`
          break;
        case "Yellow":
          code = `digitalWrite(${RGB_R}, HIGH);\n\tdigitalWrite(${RGB_G}, HIGH);\ndigitalWrite(${RGB_B}, LOW);\n`
          break;
        case "Magenta":
          code = `digitalWrite(${RGB_R}, HIGH);\n\tdigitalWrite(${RGB_B}, HIGH);\ndigitalWrite(${RGB_G}, LOW);\n`
          break;
        case "Cyan":
          code = `digitalWrite(${RGB_B}, HIGH);\n\tdigitalWrite(${RGB_G}, HIGH);\ndigitalWrite(${RGB_R}, LOW);\n`
          break;
        case "Off":
          code = `digitalWrite(${RGB_G}, LOW);\ndigitalWrite(${RGB_R}, LOW);\ndigitalWrite(${RGB_B}, LOW);\n`
          break;
        default:
          break;
      }
      return code;
    };


    // Blockly.JavaScript['led_neo_led'] = function(block) {
    //   var dropdown_neopixel_led = block.getFieldValue('NeoPixel LED');
    //   var value_red_value = Blockly.JavaScript.valueToCode(block, 'Red Value', Blockly.JavaScript.ORDER_ATOMIC);
    //   var value_green_value = Blockly.JavaScript.valueToCode(block, 'Green Value', Blockly.JavaScript.ORDER_ATOMIC);
    //   var value_blue_value = Blockly.JavaScript.valueToCode(block, 'Blue Value', Blockly.JavaScript.ORDER_ATOMIC);
    //   const block_count = Blockly.mainWorkspace.getBlocksByType('led_neo_led',true);
    //   if (peripheral_PreDeclarations.includes(`#include <Adafruit_NeoPixel.h>\nAdafruit_NeoPixel pixels = Adafruit_NeoPixel(2, A6, NEO_GRB + NEO_KHZ800);\n`) ==0){
    //     peripheral_PreDeclarations += `#include <Adafruit_NeoPixel.h>\nAdafruit_NeoPixel pixels = Adafruit_NeoPixel(2, A6, NEO_GRB + NEO_KHZ800);\n`;
    //     peripheral_SetupCode += `pixels.begin();\n`;
    //   }
    //   // TODO: Assemble JavaScript into code variable.
    //   var code = '...;\n';
    //   return code;
    // };



    Blockly.JavaScript['motor_move_indef'] = function (block) {
      var dropdown_direction = block.getFieldValue('direction');
      if (ServoDefined === false) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += ServoSetup.PreDec;
          peripheral_SetupCode += ServoSetup.Setup;
          peripheral_BulkFunctions += ServoSetup.Bulk;
          ServoDefined = true;
        }
      }
      var code = '...;\n';
      switch (dropdown_direction) {
        case "forward":
          code = `LeftServo.write(${LeftMotorACW});\nRightServo.write(${RightMotorCW});\n`;
          break;
        case "backward":
          code = `LeftServo.write(${LeftMotorCW});\nRightServo.write(${RightMotorACW});\n`;
          break;
        case "left":
          code = `LeftServo.write(${LeftMotorCW});\nRightServo.write(${RightMotorCW});\ndelay(${DSpeed});\nLeftServo.write(90);\nRightServo.write(90);\n`;
          break;
        case "right":
          code = `LeftServo.write(${LeftMotorACW});\nRightServo.write(${RightMotorACW});\ndelay(${DSpeed});\nLeftServo.write(90);\nRightServo.write(90);\n`;
          break;
        case "rleft":
          code = `LeftServo.write(${LeftMotorCW});\nRightServo.write(${RightMotorCW});\n`;
          break;
        case "rright":
          code = `LeftServo.write(${LeftMotorACW});\nRightServo.write(${RightMotorACW});\n`;
          break;
        case "stop":
          code = `LeftServo.write(90);\nRightServo.write(90);\n`;
          break;
      }
      return code;
    };

    Blockly.JavaScript['motor_single_move_indef'] = function (block) {
      var dropdown_direction = block.getFieldValue('direction');
      var dropdown_motorselect = block.getFieldValue('motorselect');
      if (ServoDefined === false) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += ServoSetup.PreDec;
          peripheral_SetupCode += ServoSetup.Setup;
          peripheral_BulkFunctions += ServoSetup.Bulk;
          ServoDefined = true;
        }
      }
      var code = '...;\n';
      switch (dropdown_direction) {
        case "forward":
          if (dropdown_motorselect === "lm") {
            code = `LeftServo.write(${LeftMotorACW});\n`;
          } else if (dropdown_motorselect === "rm") {
            code = `RightServo.write(${RightMotorCW});\n`
          }
          break;
        case "backward":
          if (dropdown_motorselect === "lm") {
            code = `LeftServo.write(${LeftMotorCW});\n`;
          } else if (dropdown_motorselect === "rm") {
            code = `RightServo.write(${RightMotorACW});\n`
          }
          break;
        case "stop":
          if (dropdown_motorselect === "lm") {
            code = `LeftServo.write(90);\n`;
          } else if (dropdown_motorselect === "rm") {
            code = `RightServo.write(90);\n`
          }
          break;
      }
      return code;
    };

    Blockly.JavaScript['motor_move_seconds'] = function (block) {
      var dropdown_direction = block.getFieldValue('direction');
      var value_seconds = Blockly.JavaScript.valueToCode(block, 'seconds', Blockly.JavaScript.ORDER_ATOMIC);
      if (ServoDefined === false) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += ServoSetup.PreDec;
          peripheral_SetupCode += ServoSetup.Setup;
          peripheral_BulkFunctions += ServoSetup.Bulk;
          ServoDefined = true;
        }
      }
      var code = '...;\n';
      switch (dropdown_direction) {
        case "forward":
          code = `LeftServo.write(${LeftMotorACW});\nRightServo.write(${RightMotorCW});\ndelay(${value_seconds * 1000});\nLeftServo.write(90);\nRightServo.write(90);\n`;
          break;
        case "backward":
          code = `LeftServo.write(${LeftMotorCW});\nRightServo.write(${RightMotorACW});\ndelay(${value_seconds * 1000});\nLeftServo.write(90);\nRightServo.write(90);\n`;
          break;
        case "rleft":
          code = `LeftServo.write(${LeftMotorCW});\nRightServo.write(${RightMotorCW});\ndelay(${value_seconds * 1000});\nLeftServo.write(90);\nRightServo.write(90);\n`;
          break;
        case "rright":
          code = `LeftServo.write(${LeftMotorACW});\nRightServo.write(${RightMotorACW});\ndelay(${value_seconds * 1000});\nLeftServo.write(90);\nRightServo.write(90);\n`;
          break;
        case "stop":
          code = `LeftServo.write(90);\nRightServo.write(90);\ndelay(${value_seconds * 1000});\n`;
          break;
      }
      return code;
    };

    Blockly.JavaScript['forklift_move_seconds'] = function (block) {
      var dropdown_direction = block.getFieldValue('direction');
      var dropdown_speed = block.getFieldValue('speed');
      var value_seconds = Blockly.JavaScript.valueToCode(block, 'seconds', Blockly.JavaScript.ORDER_ATOMIC);
      if (ServoDefined === false) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += ServoSetup.PreDec;
          peripheral_SetupCode += ServoSetup.Setup;
          peripheral_BulkFunctions += ServoSetup.Bulk;
          ServoDefined = true;
        }
      }

      var code = '...;\n';
      switch (dropdown_speed) {
        case "slow":
          code = `set_fork(0.006,${value_seconds});`
          break;
        case "medium":
          code = `set_fork(0.01,${value_seconds});`
          break;
        case "fast":
          code = `set_fork(0.032,${value_seconds});`
          break;
      }
      return code;
    };

    Blockly.JavaScript['forklift_move_indef'] = function (block) {
      var dropdown_direction = block.getFieldValue('direction');
      var dropdown_speed = block.getFieldValue('speed');
      if (ServoDefined === false) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += ServoSetup.PreDec;
          peripheral_SetupCode += ServoSetup.Setup;
          peripheral_BulkFunctions += ServoSetup.Bulk;
          ServoDefined = true;
        }
      }
      var code = '...;\n';
      switch (dropdown_direction) {
        case "up":
          if (dropdown_speed == "slow") {
            code = `raise_fork(0.006);\n`
          } else if (dropdown_speed == "medium") {
            code = `raise_fork(0.01);\n`
          } else if (dropdown_speed == "fast") {
            code = `raise_fork(0.032);\n`
          }
          break;
        case "down":
          if (dropdown_speed == "slow") {
            code = `lower_fork(0.006);\n`
          } else if (dropdown_speed == "medium") {
            code = `lower_fork(0.01);\n`
          } else if (dropdown_speed == "fast") {
            code = `lower_fork(0.032);\n`
          }
          break;
      }
      return code;
    };

    Blockly.JavaScript['servo_rotate_to_degrees'] = function (block) {
      if (ServoDefined === false) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += ServoSetup.PreDec;
          peripheral_SetupCode += ServoSetup.Setup;
          peripheral_BulkFunctions += ServoSetup.Bulk;
          ServoDefined = true;
        }
      }
      var code = '...;\n';
      return code;
    };

    Blockly.JavaScript['servo_360_rotate_direction'] = function (block) {
      var dropdown_direction = block.getFieldValue('direction');
      var dropdown_speed = block.getFieldValue('speed');
      if (ServoDefined === false) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += ServoSetup.PreDec;
          peripheral_SetupCode += ServoSetup.Setup;
          peripheral_BulkFunctions += ServoSetup.Bulk;
          ServoDefined = true;
        }
      }
      var code = '...;\n';
      return code;
    };

    // Blockly.JavaScript['variable_set'] = function(block) {
    //   var text_varname = block.getFieldValue('varname');
    //   var value_value = Blockly.JavaScript.valueToCode(block, 'value', Blockly.JavaScript.ORDER_ATOMIC);
    //   // TODO: Assemble JavaScript into code variable.
    //   var code = '...;\n';
    //   code = `${text_varname} = ${value_value};\n`
    //   return code;
    // };

    // Blockly.JavaScript['variable_get'] = function(block) {
    //   var text_varname = block.getFieldValue('varname');
    //   // TODO: Assemble JavaScript into code variable.
    //   var code = '...';
    //   code = `${text_varname}`
    //   // TODO: Change ORDER_NONE to the correct strength.
    //   return [code, Blockly.JavaScript.ORDER_NONE];
    // };

    // Blockly.JavaScript['variable_create_int'] = function(block) {
    //   var text_varname = block.getFieldValue('varname');
    //   // TODO: Assemble JavaScript into code variable.
    //   var code = '...;\n';
    //   code = `int ${text_varname};\n`
    //   return code;
    // };

    // Blockly.JavaScript['variable_create_float'] = function(block) {
    //   var text_varname = block.getFieldValue('varname');
    //   // TODO: Assemble JavaScript into code variable.
    //   var code = '...;\n';
    //   code = `float ${text_varname};\n`
    //   return code;
    // };

    export { peripheral_PreDeclarations, peripheral_BulkFunctions, peripheral_SetupCode, IR_Loop, IR_Statements, US_Trigger, US_Echo, clearvars }
  </script>


  <script type="text/javascript">
    var servo_declarations = "";  //Used to dynamically define new servos added to the workspace
    var servo_statements = "";  //Uses servo_declarations to create declaration statements for each servo.
    var servo_attach = "";  //Uses servo_declarations to create attach statements for each servo.
    var servo_number = 1;
    var peripheral_PreDeclarations = "";
    var peripheral_BulkFunctions = "";
    var peripheral_SetupCode = "";
    var IR_Loop = ``;
    var IR_Statements = "";
    Blockly.Blocks['m_mainloop'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage("https://www.clipartmax.com/png/full/219-2194283_open-green-flag-sprite.png", 40, 40, { alt: "*", flipRtl: "FALSE" }))
          .appendField("When " + " starts,", "MainField");
        this.appendDummyInput()
          .appendField("Run Forever")
          .appendField(new Blockly.FieldCheckbox("TRUE"), "LOOP");
        this.appendStatementInput("mainLoop")
          .setCheck(null);
        this.setColour("#4C97FF");
        this.setTooltip("The Main Loop of the program.");
        this.setHelpUrl("");
      },

    };
    Blockly.Blocks['delay_core'] = {
      init: function () {
        this.appendValueInput("seconds")
          .setCheck("Number")
          .appendField("delay for");
        this.appendDummyInput()
          .appendField("seconds");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setStyle("loop_blocks");
        this.setTooltip("Delays the program for a number of seconds.");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['communication_serial_print'] = {
      init: function () {
        this.appendValueInput("Serial_Print")
          .setCheck(null)
          .appendField("Print");
        this.appendDummyInput()
          .appendField(" to Serial Monitor");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setStyle("communication_blocks");
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['communication_serial_read'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Read From Serial Monitor");
        this.setInputsInline(true);
        this.setOutput(true, null);
        this.setStyle("communication_blocks");
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['arduino_digital_write'] = {
      init: function () {
        this.appendValueInput("Digital Pin Number")
          .setCheck("Number")
          .appendField("Set Digital Pin");
        this.appendDummyInput()
          .appendField("to")
          .appendField(new Blockly.FieldDropdown([["On", "HIGH"], ["Off", "LOW"]]), "On/Off");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setStyle("digital_blocks");
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['arduino_digital_read'] = {
      init: function () {
        this.appendValueInput("Digital Pin")
          .setCheck(null)
          .appendField("Read Digital Pin");
        this.setInputsInline(true);
        this.setOutput(true, null);
        this.setStyle("digital_blocks");
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['arduino_analog_write'] = {
      init: function () {
        this.appendValueInput("analog pin")
          .setCheck("String")
          .appendField("Set Analog Pin");
        this.appendValueInput("output")
          .setCheck("Number")
          .appendField("to");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setStyle("analog_blocks");
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['arduino_analog_read'] = {
      init: function () {
        this.appendValueInput("analog pin")
          .setCheck(null)
          .appendField("Read Analog Pin");
        this.setInputsInline(true);
        this.setOutput(true, null);
        this.setStyle("analog_blocks");
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['variable_set'] = {
      init: function () {
        var input = this.appendDummyInput()
          .appendField("Set Variable")
          .appendField(new Blockly.FieldDropdown(this.generateOptions), `variables_set`);
        this.appendValueInput("value")
          .setCheck(["Number", "String"])
          .appendField("to");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setStyle("variable_blocks");
        this.setTooltip("");
        this.setHelpUrl("");

      },
      generateOptions: function () {
        var options = []
        options = variables_set;
        return options;
      }
    };
    Blockly.Blocks['variable_get'] = {
      init: function () {
        var input = this.appendDummyInput()
          .appendField("Get Variable")
          .appendField(new Blockly.FieldDropdown(this.generateOptions), `variables_set`)
          .appendField("'s value");
        this.setInputsInline(true);
        this.setOutput(true, null);
        this.setStyle("variable_blocks");
        this.setTooltip("");
        this.setHelpUrl("");
      },
      generateOptions: function () {
        var options = []
        options = variables_set;
        return options;
      }
    };
    Blockly.Blocks['for_loop'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Repeat for")
          .appendField(new Blockly.FieldNumber(0, 0), "loop amount")
          .appendField("Times");
        this.appendStatementInput("for loop")
          .setCheck(null);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setStyle("loop_blocks");
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['arduino_ultrasonic_read'] = {
      init: function () {
        this.appendValueInput("trigger")
          .setCheck(null)
          .appendField("Read Ultrasonic Sensor from Trigger Pin");
        this.appendValueInput("echo")
          .setCheck(null)
          .appendField("and Echo Pin");
        this.setInputsInline(true);
        this.setOutput(true, null);
        this.setStyle("sensor_blocks");
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['arduino_servo_write'] = {
      init: function () {
        this.appendValueInput("Servo Pin")
          .setCheck(null)
          .appendField("Move Servo Pin");
        this.appendValueInput("Servo Position")
          .setCheck(null)
          .appendField("to position");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setStyle("actuator_blocks");
        this.setTooltip("");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['n_ultra_read'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage("https://www.clipartmax.com/png/full/1-17510_radio-waves-clip-art-radio-wave.png", 40, 40, { alt: "*", flipRtl: "FALSE" }))
          .appendField("Read Ultrasonic Sensor Value (cm)")
        this.setOutput(true, "Number");
        this.setColour(230);
        this.setTooltip("Read Ultrasonic Sensor Value in centimeters");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['n_servo_rotate'] = {
      init: function () {
        this.appendValueInput("degrees")
          .setCheck("Number")
          .appendField(new Blockly.FieldImage("https://static.thenounproject.com/png/1230725-200.png", 40, 40, { alt: "*ServoMotorIcon", flipRtl: "FALSE" }))
          .appendField("Rotate Servo Motor to ");
        this.appendDummyInput()
          .appendField("Degrees");
        this.setInputsInline(true);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(0);
        this.setTooltip("Rotates Servo Motor to specified number of degrees");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['n_led_state'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage("https://www.nicepng.com/png/full/92-920070_led-lamp-clipart-led-lights-png.png", 40, 40, { alt: "*", flipRtl: "FALSE" }))
          .appendField("Switch LED")
          .appendField(new Blockly.FieldDropdown([["On", "HIGH"], ["Off", "LOW"]]), "led_state");
        this.setColour(230);
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setTooltip("Turns the LED ON or OFF depending on the assigned WriteState");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['n_buzzer_play_note'] = {
      init: function () {
        this.appendValueInput("frequency")
          .setCheck("MusicNote")
          .appendField(new Blockly.FieldImage("https://i.kisscc0.com/20180813/rue/kisscc0-buzzer-computer-icons-electronics-sound-piezoelect-buzzer-5b714095dc7ed2.9012614415341487579032.png", 40, 40, { alt: "*", flipRtl: "FALSE" }))
          .appendField("Play note ");
        this.appendDummyInput();
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(60);
        this.setTooltip("Plays a music note indefinitely.");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['n_buzzer_play_note_def'] = {
      init: function () {
        this.appendValueInput("frequency")
          .setCheck("MusicNote")
          .appendField(new Blockly.FieldImage("https://i.kisscc0.com/20180813/rue/kisscc0-buzzer-computer-icons-electronics-sound-piezoelect-buzzer-5b714095dc7ed2.9012614415341487579032.png", 40, 40, { alt: "*", flipRtl: "FALSE" }))
          .appendField("Play note ");
        this.appendValueInput("seconds")
          .setCheck("Number")
          .appendField("for");
        this.appendDummyInput()
          .appendField("milliseconds");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(60);
        this.setTooltip("Plays a note for a specified number of milliseconds.");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['n_note'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Music Note:")
          .appendField(new Blockly.FieldDropdown([["C6", "1047"], ["C#6", "1109"], ["D6", "1175"], ["Eb6", "1245"], ["E6", "1319"], ["F6", "1397"], ["F#6", "1480"], ["G6", "1568"], ["G#6", "1661"], ["A6", "1760"], ["Bb6", "1865"], ["B6", "1976"], ["C7", "2093"], ["C#7", "2217"], ["D7", "2349"], ["Eb7", "2489"], ["E7", "2637"], ["F7", "2794"], ["F#7", "2960"], ["G7", "3136"], ["G#7", "3322"], ["A7", "3520"], ["Bb7", "3729"], ["B7", "3951"], ["C8", "4186"]]), "note");
        this.setOutput(true, "MusicNote");
        this.setColour(300);
        this.setTooltip("Delays the program for a number of seconds.");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['n_buzzer_stop'] = {
      init: function () {
        this.appendDummyInput()
          .appendField(new Blockly.FieldImage("https://i.kisscc0.com/20180813/rue/kisscc0-buzzer-computer-icons-electronics-sound-piezoelect-buzzer-5b714095dc7ed2.9012614415341487579032.png", 40, 40, { alt: "*", flipRtl: "FALSE" }))
          .appendField("Stop the Buzzer");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(60);
        this.setTooltip("Stops the buzzer from playing a note.");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['n_buzzer_play'] = {
      init: function () {
        this.appendValueInput("frequency")
          .setCheck("Number")
          .appendField(new Blockly.FieldImage("https://i.kisscc0.com/20180813/rue/kisscc0-buzzer-computer-icons-electronics-sound-piezoelect-buzzer-5b714095dc7ed2.9012614415341487579032.png", 40, 40, { alt: "*", flipRtl: "FALSE" }))
          .appendField("Play note at frequency of");
        this.appendDummyInput()
          .appendField("Hz");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(60);
        this.setTooltip("Plays a note at a particular frequency indefinitely.");
        this.setHelpUrl("");
      }
    };
    Blockly.Blocks['n_buzzer_play_def'] = {
      init: function () {
        this.appendValueInput("frequency")
          .setCheck("Number")
          .appendField(new Blockly.FieldImage("https://i.kisscc0.com/20180813/rue/kisscc0-buzzer-computer-icons-electronics-sound-piezoelect-buzzer-5b714095dc7ed2.9012614415341487579032.png", 40, 40, { alt: "*", flipRtl: "FALSE" }))
          .appendField("Play note at frequency of");
        this.appendDummyInput()
          .appendField("Hz");
        this.appendValueInput("seconds")
          .setCheck("Number")
          .appendField("for");
        this.appendDummyInput()
          .appendField("milliseconds");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(60);
        this.setTooltip("Plays a note at a particular frequency for a specified number of milliseconds.");
        this.setHelpUrl("");
      }
    };
    Blockly.JavaScript['arduino_ultrasonic_read'] = function (block) {
      var value_trigger = Blockly.JavaScript.valueToCode(block, 'trigger', Blockly.JavaScript.ORDER_ATOMIC);
      var value_echo = Blockly.JavaScript.valueToCode(block, 'echo', Blockly.JavaScript.ORDER_ATOMIC);
      // TODO: Assemble JavaScript into code variable.
      var code = "read_ultrasonic(" + value_trigger + "," + value_echo + ")";
      if (peripheral_PreDeclarations.includes(`int value_trigger = ${value_trigger};\nint value_echo = ${value_echo};\n\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += `int value_trigger = ${value_trigger};\nint value_echo = ${value_echo};\n\n`;
          peripheral_SetupCode += `\tpinMode(value_trigger, OUTPUT);\n\tpinMode(value_echo, INPUT);\n`;
          peripheral_BulkFunctions += `\nint read_ultrasonic(int trigger, int echo){
            digitalWrite(trigger, LOW);
            delayMicroseconds(2);
            digitalWrite(trigger, HIGH);
            delayMicroseconds(10);
            digitalWrite(trigger, LOW);
            int duration = pulseIn(echo, HIGH);
            int distance = duration * 0.034 / 2;
            return distance;
        }`
        }
      }
      return [code, Blockly.JavaScript.ORDER_NONE];
    };
    Blockly.JavaScript['arduino_servo_write'] = function (block) {
      var value_servo_pin = Blockly.JavaScript.valueToCode(block, 'Servo Pin', Blockly.JavaScript.ORDER_ATOMIC);
      var value_servo_position = Blockly.JavaScript.valueToCode(block, 'Servo Position', Blockly.JavaScript.ORDER_ATOMIC);

      var list_servo_var = Blockly.JavaScript.nameDB_.getDistinctName("myservo", Blockly.Variables.NAME_TYPE);
      servo_declarations = list_servo_var;
      peripheral_PreDeclarations += `Servo ${servo_declarations};\n`;
      peripheral_SetupCode += `\n${servo_declarations}.attach(${value_servo_pin});\n`;
      var code = `${servo_declarations}.write(${value_servo_position});\t//Move Servo to position ${value_servo_position}\n`;
      return code;
      var code = '...;\n';
      return code;
    };
    Blockly.JavaScript['n_ultra_read'] = function (block) {
      var code = "\tread_ultrasonic(" + US_Trigger + "," + US_Echo + ")\n";
      if (peripheral_PreDeclarations.includes(`int US_Trigger = ${US_Trigger};\nint US_Echo = ${US_Echo};\n\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += `int US_Trigger = ${US_Trigger};\nint US_Echo = ${US_Echo};\n\n`;
          peripheral_SetupCode += `\tpinMode(${US_Trigger}, OUTPUT);\n\tpinMode(${US_Echo}, INPUT);\n`;
          peripheral_BulkFunctions += `\nint read_ultrasonic(int trigger, int echo){
            digitalWrite(trigger, LOW);
            delayMicroseconds(2);
            digitalWrite(trigger, HIGH);
            delayMicroseconds(10);
            digitalWrite(trigger, LOW);
            int duration = pulseIn(echo, HIGH);
            int distance = duration * 0.034 / 2;
            return distance;
        }`
        }
      }
      return [code, Blockly.JavaScript.ORDER_NONE];
    };
    Blockly.JavaScript['n_servo_rotate'] = function (block) {
      if (peripheral_PreDeclarations.includes("#include <Servo.h>\n Servo ServoA\n") == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_PreDeclarations += "#include <Servo.h>\n Servo ServoA\n";
        }
      }
      if (peripheral_SetupCode.includes(`\tServoA.attach(${Servo_Pin});\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_SetupCode += `\tServoA.attach(${Servo_Pin});\n`;
        }
      }
      var value_degrees = Blockly.JavaScript.valueToCode(block, 'degrees', Blockly.JavaScript.ORDER_ATOMIC);
      var code = '\n\tServoA.write(' + value_degrees + ');\n';
      return code;
    };
    Blockly.JavaScript['n_led_state'] = function (block) {
      var value_led_value = block.getFieldValue("led_state");
      // TODO: Assemble JavaScript into code variable.
      if (peripheral_SetupCode.includes(`\tpinMode(LED_BUILTIN, OUTPUT)\n`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          peripheral_SetupCode += `\tpinMode(LED_BUILTIN, OUTPUT);\n`;
        }
      }
      var code = `\n\tdigitalWrite(LED_BUILTIN,${value_led_value});\n`;
      return code;
    };
    Blockly.JavaScript['n_buzzer_play'] = function (block) {
      var value_frequency = Blockly.JavaScript.valueToCode(block, 'frequency', Blockly.JavaScript.ORDER_ATOMIC);
      // TODO: Assemble JavaScript into code variable.
      var code = '\ntone(Buzzer_Pin,' + value_frequency + ');';
      return code;
    };
    Blockly.JavaScript['n_buzzer_stop'] = function (block) {
      // TODO: Assemble JavaScript into code variable.
      var code = '\nnoTone(Buzzer_Pin);';
      return code;
    };
    Blockly.JavaScript['n_buzzer_play_def'] = function (block) {
      var value_frequency = Blockly.JavaScript.valueToCode(block, 'frequency', Blockly.JavaScript.ORDER_ATOMIC);
      var value_seconds = Blockly.JavaScript.valueToCode(block, 'seconds', Blockly.JavaScript.ORDER_ATOMIC);
      // TODO: Assemble JavaScript into code variable.
      var code = '\ntone(Buzzer_Pin,' + value_frequency + ');\ndelay(' + value_seconds + ');\nnoTone(Buzzer_Pin);';
      return code;
    };
    Blockly.JavaScript['n_note'] = function (block) {
      var dropdown_note = block.getFieldValue('note');
      // TODO: Assemble JavaScript into code variable.
      var code = dropdown_note;
      // TODO: Change ORDER_NONE to the correct strength.
      return [code, Blockly.JavaScript.ORDER_NONE];
    };
    Blockly.JavaScript['n_delay'] = function (block) {
      var value_seconds = Blockly.JavaScript.valueToCode(block, 'seconds', Blockly.JavaScript.ORDER_ATOMIC);
      // TODO: Assemble JavaScript into code variable.
      var code = '\ndelay(' + value_seconds + ');';
      return code;
    };
    Blockly.JavaScript['n_buzzer_play_note'] = function (block) {
      var value_frequency = Blockly.JavaScript.valueToCode(block, 'frequency', Blockly.JavaScript.ORDER_ATOMIC);
      // TODO: Assemble JavaScript into code variable.
      var code = '\ntone(Buzzer_Pin,' + value_frequency + ');';
      return code;
    };
    Blockly.JavaScript['n_buzzer_play_note_def'] = function (block) {
      var value_frequency = Blockly.JavaScript.valueToCode(block, 'frequency', Blockly.JavaScript.ORDER_ATOMIC);
      var value_seconds = Blockly.JavaScript.valueToCode(block, 'seconds', Blockly.JavaScript.ORDER_ATOMIC);
      // TODO: Assemble JavaScript into code variable.
      var code = '\ntone(Buzzer_Pin,' + value_frequency + ');\ndelay(' + value_seconds + ');\nnoTone(Buzzer_Pin);';
      return code;
    };
    Blockly.JavaScript['m_mainloop'] = function (block) {
      var statements_mainloop = Blockly.JavaScript.statementToCode(block, 'mainLoop');
      var checkbox_loop = block.getFieldValue("LOOP");
      var code = ""
      code = `void setup(){\n}\n\nvoid loop(){\n ${statements_mainloop}\n}`;
      mainLoopCode = code;
      return code;
    };
    Blockly.JavaScript['delay_core'] = function (block) {
      var value_seconds = Blockly.JavaScript.valueToCode(block, 'seconds', Blockly.JavaScript.ORDER_ATOMIC);
      var code = `\ndelay(${value_seconds * 1000});\n`;
      return code;
    };
    Blockly.JavaScript['communication_serial_print'] = function (block) {
      var value_serial_print = Blockly.JavaScript.valueToCode(block, 'Serial_Print', Blockly.JavaScript.ORDER_ATOMIC);
      if (value_serial_print[0] == `'`) {
        value_serial_print = value_serial_print.replaceAll(`'`, `"`);
      }
      if (Total_SetupCode.includes(`Serial.begin(9600);`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          Total_SetupCode += `\tSerial.begin(9600);\n`;
        }
      }
      var code = `\tSerial.println(${value_serial_print});\n`;
      return code;
    };
    Blockly.JavaScript['communication_serial_read'] = function (block) {
      if (Total_SetupCode.includes(`Serial.begin(9600);`) == 0) {
        Total_SetupCode += `\tSerial.begin(9600);\n`;
      }
      var code = ""
      if (block.getRootBlock().type == "m_mainloop") {

        code = `Serial.read()`;
        console.log(code)
      }
      return [code, Blockly.JavaScript.ORDER_NONE];
    };
    Blockly.JavaScript['variable_set'] = function (block) {
      var text_varname = block.getFieldValue('variables_set');
      var value_value = Blockly.JavaScript.valueToCode(block, 'value', Blockly.JavaScript.ORDER_ATOMIC);

      var code = '';
      code = `${text_varname} = ${value_value};\n`
      return code;
    };
    Blockly.JavaScript['variable_get'] = function (block) {
      var text_varname = block.getFieldValue('variables_set');
      var code = '...';
      code = `${text_varname}`
      return [code, Blockly.JavaScript.ORDER_NONE];
    };
    Blockly.JavaScript['for_loop'] = function (block) {
      var number_loop_amount = block.getFieldValue('loop amount');
      var statements_for_loop = Blockly.JavaScript.statementToCode(block, 'for loop');
      // TODO: Assemble JavaScript into code variable.
      var code = 'for (int i = 0;i<' + number_loop_amount + ';i++) {\n' + statements_for_loop + '};\n';
      return code;
    };
    Blockly.JavaScript['arduino_digital_write'] = function (block) {
      var value_digital_pin_number = Blockly.JavaScript.valueToCode(block, 'Digital Pin Number', Blockly.JavaScript.ORDER_ATOMIC);
      var dropdown_on_off = block.getFieldValue('On/Off');
      if (Total_SetupCode.includes(`pinMode(${value_digital_pin_number}, OUTPUT)`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          Total_SetupCode += `pinMode(${value_digital_pin_number}, OUTPUT);\n`
        }
      }
      var code = `digitalWrite(${value_digital_pin_number},${dropdown_on_off});\n`;
      return code;
    };
    Blockly.JavaScript['arduino_digital_read'] = function (block) {
      var value_digital_pin_number = Blockly.JavaScript.valueToCode(block, 'Digital Pin', Blockly.JavaScript.ORDER_ATOMIC);
      if (Total_SetupCode.includes(`pinMode(${value_digital_pin_number}, INPUT)`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          Total_SetupCode += `pinMode(${value_digital_pin_number}, INPUT);\n`
        }
      }
      var code = `digitalRead(${value_digital_pin_number})`;
      // TODO: Change ORDER_NONE to the correct strength.
      return [code, Blockly.JavaScript.ORDER_NONE];
    };
    Blockly.JavaScript['arduino_analog_write'] = function (block) {
      var value_analog_pin_number = Blockly.JavaScript.valueToCode(block, 'analog pin', Blockly.JavaScript.ORDER_ATOMIC);
      var value_output = Blockly.JavaScript.valueToCode(block, 'output', Blockly.JavaScript.ORDER_ATOMIC);
      if (Total_SetupCode.includes(`pinMode(${value_analog_pin_number}, OUTPUT)`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          Total_SetupCode += `pinMode(${value_analog_pin_number}, OUTPUT);\n`
        }
      }
      var code = `analogWrite(${value_analog_pin_number},${value_output});\n`;
      return code;
    };
    Blockly.JavaScript['arduino_analog_read'] = function (block) {
      var value_analog_pin_number = Blockly.JavaScript.valueToCode(block, 'analog pin', Blockly.JavaScript.ORDER_ATOMIC);
      // TODO: Assemble JavaScript into code variable.
      if (Total_SetupCode.includes(`pinMode(${value_analog_pin_number}, INPUT)`) == 0) {
        if (block.getRootBlock().type == "m_mainloop") {
          Total_SetupCode += `pinMode(${value_analog_pin_number}, INPUT);\n`
        }
      }

      var code = `analogRead(${value_analog_pin_number})`;
      // TODO: Change ORDER_NONE to the correct strength.
      return [code, Blockly.JavaScript.ORDER_NONE];
    };
  </script>
</head>

<body>
  <div id="blocklyDiv" style="position: absolute; height: 100%; width: 100%; top: 0; left: 0; border: none"></div>
  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category css-icon="customIcon fa fa-cog" name="Logic">
      <block type="controls_if"></block>
      <block type="logic_compare">
        <field name="OP">EQ</field>
      </block>
      <block type="logic_operation">
        <field name="OP">AND</field>
      </block>
      <block type="logic_negate"></block>
      <block type="logic_boolean">
        <field name="BOOL">TRUE</field>
      </block>
    </category>
    <category name="Loops">
      <block type="for_loop">
      </block>
      <block type="controls_whileUntil">
        <field name="MODE">WHILE</field>
      </block>
      <block type="delay_core">
        <value name="seconds">
          <shadow type="math_number">
            <field name="seconds">1</field>
          </shadow>
        </value>
      </block>
    </category>
    <category css-icon="customIcon fa fa-cog" name="Math">
      <block type="math_number">
        <field name="NUM">0</field>
      </block>
      <block type="math_arithmetic">
        <field name="OP">ADD</field>
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_number_property">
        <mutation divisor_input="false"></mutation>
        <field name="PROPERTY">EVEN</field>
        <value name="NUMBER_TO_CHECK">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
    </category>
    <category css-icon="customIcon fa fa-cog" name="Text">
      <block type="text">
        <field name="TEXT"></field>
      </block>
      <block type="text_join">
        <mutation items="2"></mutation>
      </block>
    </category>
    <category css-icon="customIcon fa fa-cog" name="Actuators">
      <category name="Motor">
        <block type="motor_move_indef">
          <field name="direction">forward</field>
        </block>
        <block type="motor_single_move_indef">
          <field name="motorselect">lm</field>
          <field name="direction">forward</field>
        </block>
        <block type="motor_move_seconds">
          <field name="direction">forward</field>
          <value name="seconds">
            <block type="math_number">
              <field name="NUM">0</field>
            </block>
          </value>
        </block>
      </category>
      <category name="Forklift">
        <block type="forklift_move_seconds">
          <field name="direction">up</field>
          <field name="speed">slow</field>
          <value name="seconds">
            <block type="math_number">
              <field name="NUM">0</field>
            </block>
          </value>
        </block>
        <block type="forklift_move_indef">
          <field name="direction">up</field>
          <field name="speed">slow</field>
        </block>
      </category>
    </category>
    <category css-icon="customIcon fa fa-cog" name="Sensors">
      <category name="Ultrasonic">
        <block type="sensor_ultrasonic"></block>
      </category>
      <category name="Light Follower">
        <block type="sensor_light_follower_right"></block>
        <block type="sensor_light_follower_left"></block>
      </category>
      <category name="Line Follower">
        <block type="sensor_line_follower_right">
          <field name="Right Line Follower Value">On</field>
        </block>
        <block type="sensor_line_follower_left">
          <field name="Left Line Follower Value">On</field>
        </block>
      </category>
    </category>
    <category css-icon="customIcon fa fa-cog" name="COM">
      <category name="IR Control">
        <block type="communication_infrared_start"></block>
        <block type="communication_infrared_value">
          <field name="Received_Character">FF629D</field>
        </block>
      </category>
      <category name="Bluetooth">
        <block type="communication_bluetooth_start"></block>
        <block type="communication_bluetooth_receive">
          <value name="NAME">
            <block type="text">
              <field name="TEXT"></field>
            </block>
          </value>
        </block>
        <block type="communincation_bluetooth_send">
          <value name="NAME">
            <block type="text">
              <field name="TEXT"></field>
            </block>
          </value>
        </block>
      </category>
      <category name="Serial">
        <block type="communication_serial_print">
          <value name="Serial_Print">
            <block type="text">
              <field name="A1"></field>
            </block>
          </value>
        </block>
        <block type="communication_serial_read"></block>
      </category>
    </category>
    <category css-icon="customIcon fa fa-cog" name="LEDs">

      <block type="led_rgb_led">
        <field name="LED">Left</field>
        <field name="colour">Red</field>
        <field name="colour value">On</field>
      </block>
      <block type="led_rgb_led_all">
        <field name="LED">Left</field>
        <field name="colour">Red</field>
      </block>

    </category>
    <category css-icon="customIcon fa fa-cog" name="Sound">

      <block type="sound_buzzer_timer">
        <field name="note">1047</field>
        <value name="Buzzer Time">
          <block type="math_number">
            <field name="NUM">0</field>
          </block>
        </value>
      </block>
      <block type="sound_buzzer_buzz">
        <field name="Note">1047</field>
      </block>
      <block type="sound_buzzer_stop"></block>

    </category>

    <category name="Variables">
      <button text="Create New Variable" callbackKey="createvar"></button>
      <block type="variable_get"></block>
      <block type="variable_set"></block>
    </category>

  </xml>
  </xml>
  </div>
  <script type="text/javascript">
    const block_styles = {
      "logic_blocks": {
        "colourPrimary": "#4C97FF",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "loop_blocks": {
        "colourPrimary": "#DD0A18",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "text_blocks": {
        "colourPrimary": "#16CE9C",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "math_blocks": {
        "colourPrimary": "#8D00E8",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "actuator_blocks": {
        "colourPrimary": "#FE8013",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "sensor_blocks": {
        "colourPrimary": "#40BF4A",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "communication_blocks": {
        "colourPrimary": "#D51CD5",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "led_blocks": {
        "colourPrimary": "#EFCA0F",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "sound_blocks": {
        "colourPrimary": "#FA857B",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "variable_blocks": {
        "colourPrimary": "#878787",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "digital_blocks": {
        "colourPrimary": "#1F5D00",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      },
      "analog_blocks": {
        "colourPrimary": "#FF00BB",
        "colourSecondary": "#FFFFFF",
        "colourTertiary": "#FFFFFF"
      }

    }
    const font_styles = {
      "family": "Baloo2-Regular",
      "size": 14
    }
    const dark_component_styles = {
      "workspaceBackgroundColour": "#060841",
      "flyoutBackgroundColour": "#0B0533",
      "toolboxBackgroundColour": "#0B0533",
      "toolboxForegroundColour": "#FFFFFF"
    }

    var toolboxVisible = false;
    function clickOnToolbox(item) {
      Blockly.mainWorkspace.toolbox_.selectItemByPosition(item);
    }

    function returnToolbox() {
      var toolbox_temp = [];
      for (var i = 0; i < (Blockly.mainWorkspace.toolbox_.getToolboxItems()).length; i++) {
        var items = Blockly.mainWorkspace.toolbox_.getToolboxItems();
        var id = items[i].id_
        var name = items[i].name_
        if (items[i].subcategoriesDiv_ === undefined) {
          toolbox_temp.push([name, id, "non-category"]);
        }
        else {
          var category = Blockly.mainWorkspace.toolbox_.getToolboxItems()[i];
          category.setExpanded(true)
          var children_count = (category.getChildToolboxItems()).length
          toolbox_temp.push([name, id, "category", children_count]);
        }
      }
      console.log("toolbox:" + toolbox_temp);
      window.addEventListener("flutterInAppWebViewPlatformReady", function (event) {
        window.flutter_inappwebview.callHandler('sendToFlutter', [1, 2])
      });
      return toolbox_temp;
    
    }

    function showToolbox(){
      if (toolboxVisible){
        Blockly.mainWorkspace.toolbox_.setVisible(false)
      }
      else{
        Blockly.mainWorkspace.toolbox_.setVisible(true)
      }
    }

    function updateCode() {
      var code = Blockly.JavaScript.workspaceToCode(Blockly.mainWorkspace);
      window.addEventListener("flutterInAppWebViewPlatformReady", function (event) {
        console.log(event)
        window.flutter_inappwebview.callHandler('sendToFlutter', code).then(function (result) {
          // get result from Flutter side. It will be the number 64.
          console.log(result);
        });
      });
    }

    var dark_theme = Blockly.Theme.defineTheme('dark_theme', {
      'blockStyles': block_styles,
      'fontStyle': font_styles,
      'componentStyles': dark_component_styles,
      'startHats': true
    })
    var Workspace = Blockly.inject('blocklyDiv',
      {
        media: "../../media/",
        toolbox: document.getElementById('toolbox'),
        zoom:
        {
          wheel: true,
          control: true,
          startScale: 0.5,
          maxScale: 3,
          minScale: 0.3,
          scaleSpeed: 1.2,
          pinch: true
        },
        renderer: "zelos",
        trashcan: false,
        theme: dark_theme
      });
    Workspace.toolbox_.setVisible(false);
    Workspace.addChangeListener(updateCode);
    Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(`<xml xmlns="https://developers.google.com/blockly/xml"><block type="m_mainloop" x="430" y="150"></block></xml>`), Workspace)

  </script>
  <script src="scripts/main.js"></script>
</body>

</html>